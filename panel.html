<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>

/* ====== GENERAL ====== */
body{
margin:0;
font-family:Arial, sans-serif;
background:#f4f4f4;
}

/* ====== LAYOUT ====== */
.container{
display:flex;
height:100vh;
}

/* ====== SIDEBAR ====== */
.sidebar{
width:220px;
background:#222;
color:white;
padding:15px;
overflow-y:auto;
}

.sidebar h3{
margin-top:0;
}

.fecha-btn{
background:#333;
padding:8px;
margin-bottom:8px;
border-radius:6px;
cursor:pointer;
}

.fecha-btn:hover{
background:#444;
}

/* ====== MAIN ====== */
.main{
flex:1;
padding:20px;
overflow-y:auto;
}

.grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
gap:15px;
}

.card{
background:white;
padding:15px;
border-radius:10px;
cursor:pointer;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

.card h4{
margin:0;
}

/* ====== MODAL ====== */
.modal{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.6);
display:none;
align-items:center;
justify-content:center;
}

/* ====== TICKET 80MM ====== */
.ticket{
background:white;
width:80mm;
max-width:80mm;
padding:10px;
font-family:monospace;
font-size:12px;
}

.logo{
text-align:center;
margin-bottom:5px;
}

.logo img{
width:120px;
max-width:100%;
}

.encabezado{
text-align:center;
margin-bottom:8px;
}

textarea{
width:100%;
height:180px;
font-size:12px;
border:1px solid #ccc;
}

button{
width:100%;
margin-top:6px;
padding:8px;
cursor:pointer;
}

/* ====== SOLO IMPRIME TICKET ====== */
@media print {

body *{
visibility:hidden;
}

.ticket, .ticket *{
visibility:visible;
}

.ticket{
position:absolute;
left:0;
top:0;
width:80mm;
}

textarea{
border:none;
resize:none;
}

button{
display:none;
}

}

</style>
</head>

<body>

<div class="container">

<div class="sidebar">
<h3>Fechas</h3>
<div id="fechas"></div>
</div>

<div class="main">
<h2>Pedidos del dÃ­a</h2>
<div class="grid" id="grid"></div>
</div>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
<div class="ticket">

<div class="logo">
<img src="logo.png">
</div>

<div class="encabezado" contenteditable="true">
<strong>PanaderÃ­a Andrey</strong><br>
NIT: 123456789<br>
Tel: 3000000000<br>
Barrio: San Telmo
</div>

<hr>

<div id="clienteNombre"></div>

<textarea id="facturaTexto"></textarea>

<button onclick="imprimir()">ðŸ–¨ Imprimir</button>
<button onclick="guardar()">ðŸ’¾ Guardar cambios</button>
<button onclick="cerrar()">Cerrar</button>

</div>
</div>

<script>

// ====== CONFIGURA TU SUPABASE ======
const SUPABASE_URL = "TU_SUPABASE_URL";
const SUPABASE_KEY = "TU_SUPABASE_ANON_KEY";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

let pedidoId = null;

// ====== CARGAR FECHAS ======
async function cargarFechas(){
const { data } = await db
.from("pedidos")
.select("fecha")
.order("fecha",{ascending:false});

if(!data) return;

let fechas = [...new Set(data.map(p => p.fecha.split("T")[0]))];

let cont = document.getElementById("fechas");
cont.innerHTML = "";

fechas.forEach(f=>{
cont.innerHTML += `<div class="fecha-btn" onclick="cargarPedidos('${f}')">${f}</div>`;
});
}

// ====== CARGAR PEDIDOS ======
async function cargarPedidos(fecha){

const { data } = await db
.from("pedidos")
.select("*")
.gte("fecha", fecha+"T00:00:00")
.lte("fecha", fecha+"T23:59:59");

let grid = document.getElementById("grid");
grid.innerHTML = "";

if(!data) return;

data.forEach(p=>{
grid.innerHTML += `
<div class="card" onclick="abrir(${p.id}, \`${p.pedido}\`, \`${p.cliente}\`)">
<h4>${p.cliente}</h4>
<p>$${p.total}</p>
</div>
`;
});
}

// ====== ABRIR TICKET ======
function abrir(id, texto, cliente){
pedidoId = id;
document.getElementById("modal").style.display = "flex";
document.getElementById("facturaTexto").value = texto;
document.getElementById("clienteNombre").innerHTML = "<strong>Cliente:</strong> " + cliente;
}

// ====== GUARDAR ======
async function guardar(){
let nuevo = document.getElementById("facturaTexto").value;

await db
.from("pedidos")
.update({pedido:nuevo})
.eq("id", pedidoId);

alert("Factura actualizada âœ”");
}

// ====== IMPRIMIR ======
function imprimir(){
window.print();
}

// ====== CERRAR ======
function cerrar(){
document.getElementById("modal").style.display="none";
}

cargarFechas();

</script>

</body>
</html>
